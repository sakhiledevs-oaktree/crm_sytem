<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CRM Cohort Manager | Oaktree People Solutions</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        /* Visual refinements */
        .chart-label { font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 15px; font-weight: 700; }
        .feed-item { padding: 12px; border-bottom: 1px solid #f1f5f9; transition: background 0.2s; }
        .feed-item:hover { background: #f8fafc; }
        .s-tab.active { background: #ef4444 !important; color: white !important; border-color: #ef4444 !important; }
        .progress-bg { background: #f1f5f9; height: 8px; border-radius: 10px; overflow: hidden; margin-top: 4px; }
        .progress-fill { height: 100%; transition: width 0.5s ease-in-out; }
        .table-responsive { position: relative; }
        .dot.guest { background: #64748b; }
        .nav-btn.active .dot.guest { background: #fff; }
        
        .badge-purple {
            background: #f3e8ff; 
            color: #7e22ce;      
            font-size: 0.6rem;
            padding: 2px 8px;
            border-radius: 99px;
            font-weight: 700;
            text-transform: uppercase;
            margin-left: 8px;
            border: 1px solid #d8b4fe;
            display: inline-flex;
            align-items: center;
        }

        .table-row:hover td { background-color: #f8fafc !important; }
    </style>
</head>
<body class="app-bg">

<nav class="top-nav">
    <div class="nav-container">
        <div class="brand">CRM <span> OAKTREEPEOPLE</span></div>
        <div class="nav-buttons">
            <a class="nav-btn {% if cohort == 'All' %}active{% endif %}" href="/?cohort=All">All Candidates</a>
            {% for d in ["Monday", "Tuesday", "Wednesday", "Thursday"] %}
              <a class="nav-btn {% if cohort == d %}active{% endif %}" href="/?cohort={{ d }}">
                  <span class="dot {{ d|lower }}"></span> {{ d }}
              </a>
            {% endfor %}
            <a class="nav-btn {% if cohort == 'Guest' %}active{% endif %}" href="/?cohort=Guest" style="border-left: 1px solid #e2e8f0; margin-left: 10px; padding-left: 15px;">
                <span class="dot guest"></span> Guests
            </a>
        </div>
        <div class="nav-right">
            <form method="POST" action="/upload/{{ cohort }}" enctype="multipart/form-data" id="masterUploadForm">
                <input type="file" name="file" id="masterFile" hidden accept=".csv, .xlsx, .xls" onchange="this.form.submit()">
                <label for="masterFile" class="import-trigger">
                    <span class="icon">↑</span> Import List
                </label>
            </form>
        </div>
    </div>
</nav>

<div class="container">
    <header class="page-header">
        <div class="header-titles">
            <div class="breadcrumb">Mentorship Program / {{ cohort }}</div>
            <h1>{{ cohort if cohort != 'All' else 'Master Database' }} 
                <span class="count-badge">{{ rows|length }} entries</span>
            </h1>
        </div>
        <div class="search-area">
            <input type="text" id="crmSearch" placeholder="Search by name, email, or ID..." onkeyup="filterTable()">
        </div>
    </header>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for message in messages %}
          <div class="alert success">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% if cohort != 'All' %}
    <div class="data-card" style="margin-bottom: 24px; background: #f8fafc; border-left: 5px solid #2563eb; padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 class="chart-label" style="color: #2563eb; margin-bottom: 0;">Teams Attendance Sync (Sessions 1-6)</h3>
            <span style="font-size: 0.7rem; color: #64748b; font-weight: 600;">UPLOAD TEAMS EXPORT (.CSV / .XLSX)</span>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            {% for i in range(1, 7) %}
            <form action="/upload_attendance/{{ i }}?cohort={{ cohort }}" method="POST" enctype="multipart/form-data" id="form-attn-{{ i }}">
                <input type="file" name="attendance_file" id="attn-{{ i }}" hidden onchange="document.getElementById('form-attn-{{ i }}').submit()">
                <label for="attn-{{ i }}" class="nav-btn" style="padding: 8px 14px; background: white; border: 1px solid #e2e8f0; color: #1e293b; font-size: 0.75rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px;">
                    <span style="width: 8px; height: 8px; background: #2563eb; border-radius: 50%;"></span>
                    Session {{ i }}
                </label>
            </form>
            {% endfor %}
        </div>
    </div>

    <div class="data-card" style="padding: 20px; margin-bottom: 24px;">
        <div id="verifiedAttendanceTrendChart"></div>
    </div>

    <div class="analytics-row" style="display: grid; grid-template-columns: 1.2fr 1fr 1fr 0.8fr; gap: 20px; margin-bottom: 24px;">
        <div class="data-card" style="padding: 20px;">
            <h3 class="chart-label">Engagement Depth (Attended vs Surveyed)</h3>
            <div id="engagementDepthChart"></div>
        </div>
        <div class="data-card" style="padding: 20px;">
            <h3 class="chart-label">Survey Volume</h3>
            <div id="attendanceTrendChart"></div>
        </div>
        <div class="data-card" style="padding: 20px;">
            <h3 class="chart-label">Sentiment Pulse (Avg)</h3>
            <div id="sentimentRadarChart"></div>
        </div>
        <div class="data-card" style="padding: 20px; text-align: center;">
            <h3 class="chart-label">Response Gauge</h3>
            <div id="responseGaugeChart"></div>
        </div>
        <!-- <div class="stat-card">
            <h3>Verified Attendees</h3>
            <p class="stat-number">{{ total_attendees }}</p>
            <small>Excl. Staff & Unmatched</small>
        </div> -->
    </div>

    <div class="data-card" style="padding: 20px; margin-bottom: 24px;">
        <h3 class="chart-label">Recent Key Learnings</h3>
        <div class="learning-feed" style="max-height: 180px; overflow-y: auto;">
            {% for c in comments %}
            <div class="feed-item">
                <div style="display: flex; gap: 10px;">
                    <span style="color: #ef4444; font-weight: 800; font-size: 0.7rem;">LEARNING</span>
                    <span style="font-size: 0.85rem; color: #1e293b;">"{{ c.key_learnings }}"</span>
                </div>
                <div style="margin-left: 70px; font-size: 0.75rem; color: #64748b; margin-top: 4px;">
                    <strong>Plan:</strong> {{ c.apply_plan[:120] if c.apply_plan else 'N/A' }}...
                </div>
            </div>
            {% endfor %}
            {% if not comments %}
            <p style="text-align: center; color: #94a3b8; font-size: 0.85rem; padding: 20px;">No survey responses yet.</p>
            {% endif %}
        </div>
    </div>

    <div style="margin-bottom: 25px; background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
        <div style="display: flex; align-items: center; margin-bottom: 12px; gap: 10px;">
            <div style="background: #25d366; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                <svg style="width: 18px; fill: white;" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.588-5.946 0-6.556 5.332-11.891 11.891-11.891 3.181 0 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.231 3.481 8.403 0 6.556-5.332 11.891-11.891 11.891-2.007 0-3.982-.51-5.735-1.474l-6.259 1.692zm6.21-4.412l.348.206c1.517.899 3.256 1.373 5.042 1.373 5.309 0 9.631-4.322 9.631-9.631 0-2.573-1.001-4.991-2.82-6.81-1.817-1.817-4.234-2.817-6.81-2.817-5.31 0-9.632 4.322-9.632 9.631 0 1.936.582 3.823 1.684 5.438l.227.333-1.007 3.676 3.77-.999z"/></svg>
            </div>
            <h3 style="margin: 0; font-size: 0.95rem; font-weight: 700; color: #1e293b;">WhatsApp Automation Drafter</h3>
        </div>
        <textarea id="whatsappTemplate" 
            style="width: 100%; height: 60px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem; resize: none; outline: none;" 
            placeholder="Hello {name}, ..."
            oninput="localStorage.setItem('whatsapp_pretext', this.value)"></textarea>
    </div>

    <div class="data-card" style="padding: 20px; margin-bottom: 24px; border-left: 5px solid #ef4444;">
        <h3 class="chart-label" style="margin-bottom: 10px;">Session Distribution Tool</h3>
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <span style="font-size: 0.85rem; font-weight: 600;">Copy Survey Link:</span>
            {% for i in range(1, 7) %}
            <button class="nav-btn" style="padding: 6px 12px; font-size: 0.75rem;" onclick="copySurveyLink('{{ cohort|lower }}', 's{{ i }}')">
                S{{ i }}
            </button>
            {% endfor %}
            <span id="copyStatus" style="font-size: 0.75rem; color: #10b981; display: none; margin-left: 10px;">✓ Copied!</span>
        </div>
    </div>
    {% endif %}

    <div class="data-card">
        {% include "partials/client_table.html" %}
    </div>
</div>

<div id="sideDrawer" class="drawer">
    <div class="drawer-header" style="display: flex; align-items: center; gap: 16px; padding: 20px; border-bottom: 1px solid #f1f5f9;">
        <button onclick="closeDrawer()" class="close-btn-premium" style="background: #f1f5f9; color: #64748b; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer;">&times;</button>
        <div class="header-info">
            <h2 id="drawerName" style="margin: 0; font-size: 1.1rem; font-weight: 700;">Candidate Profile</h2>
            <span id="drawerEmail" style="color: #64748b; font-size: 0.8rem;"></span>
        </div>
    </div>
    <div class="drawer-content" style="padding: 20px;">
        <div class="survey-tabs" style="display: flex; gap: 6px; margin-bottom: 20px;">
            {% for i in range(1, 7) %}
            <button class="s-tab" id="tab-s{{ i }}" 
                    style="flex: 1; padding: 8px; font-size: 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; background: white; cursor: pointer;"
                    onclick="fetchSurvey({{ i }})">S{{ i }}</button>
            {% endfor %}
        </div>
        <div id="questionsList">
            <p style="color: #94a3b8; text-align: center; margin-top: 40px;">Select a session to view feedback</p>
        </div>
    </div>
</div>
<div id="drawerOverlay" class="drawer-overlay" onclick="closeDrawer()"></div>

<script>
let currentEmail = null;

function filterTable() {
    let input = document.getElementById("crmSearch");
    let filter = input.value.toUpperCase();
    let tr = document.querySelectorAll(".table tbody tr");
    tr.forEach(row => {
        let text = row.innerText.toUpperCase();
        row.style.display = text.includes(filter) ? "" : "none";
    });
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('whatsappTemplate').value = localStorage.getItem('whatsapp_pretext') || "";
});

function sendWhatsApp(phone, clientName, event) {
    if (!phone || phone === '-') return;

    // Get message from drafter
    let template = document.getElementById('whatsappTemplate')?.value;
    if (!template || template.trim() === "") {
        alert("Type a message in the WhatsApp drafter first!");
        return;
    }

    // Clean phone number
    let cleanPhone = phone.replace(/\D/g, '');

    // Convert SA local number to international format
    if (cleanPhone.startsWith('0')) {
        cleanPhone = '27' + cleanPhone.substring(1);
    }

    // Replace {name} placeholder
    let finalMessage = template.replace(/{name}/gi, clientName);

    // Encode message
    const encodedMessage = encodeURIComponent(finalMessage);

    // Mark as sent in localStorage
    localStorage.setItem('sent_' + cleanPhone, 'true');

    // Update button UI
    const btn = event.currentTarget;
    btn.style.background = '#94a3b8';
    btn.innerText = 'SENT';

    // Open WhatsApp
    window.open(`https://wa.me/${cleanPhone}?text=${encodedMessage}`, '_blank');
}

document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('.whatsapp-btn').forEach(btn => {
        const phone = btn.getAttribute('data-phone').replace(/\D/g, '');
        const cleanPhone = phone.startsWith('0') ? '27' + phone.substring(1) : phone;
        if (localStorage.getItem('sent_' + cleanPhone)) {
            btn.style.background = '#94a3b8';
            btn.innerText = 'SENT';
        }
    });
});

function saveComment(idNumber, text, btn) {
    // Reference the original color so we can switch back
    const originalBg = btn.style.background;

    fetch('/update_comment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            id_number: idNumber, 
            comment: text 
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            // Flash Green for success
            btn.style.background = "#22c55e"; 
            
            // Optional: change the icon inside if you want
            const svg = btn.querySelector('svg');
            if(svg) svg.style.stroke = "white";

            // Switch back to original blue after 1.5 seconds
            setTimeout(() => {
                btn.style.background = originalBg;
            }, 1500);
        } else {
            alert("Error saving: " + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        btn.style.background = "#ef4444"; // Flash Red on failure
    });
}
function openCandidateProfile(email, name) {
    currentEmail = email;
    document.getElementById('drawerName').innerText = name;
    document.getElementById('drawerEmail').innerText = email;
    document.getElementById('sideDrawer').classList.add('open');
    document.getElementById('drawerOverlay').classList.add('active');
    fetchSurvey(1); 
}

function closeDrawer() {
    document.getElementById('sideDrawer').classList.remove('open');
    document.getElementById('drawerOverlay').classList.remove('active');
}

async function fetchSurvey(num) {
    document.querySelectorAll('.s-tab').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-s${num}`).classList.add('active');
    try {
        const r = await fetch(`/api/surveys/${encodeURIComponent(currentEmail)}/${num}`);
        const data = await r.json();
        renderIndividualScores(data.scores, data.feedback);
    } catch (e) { renderIndividualScores([0, 0], null); }
}

function renderIndividualScores(scores, feedback) {
    const container = document.getElementById('questionsList');
    let html = ["Quality", "Relevance"].map((l, i) => `
        <div style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: 600;">
                <span>${l}</span><span>${scores[i] || 0}/5</span>
            </div>
            <div class="progress-bg"><div class="progress-fill" style="width: ${(scores[i] || 0) * 20}%; background: #ef4444;"></div></div>
        </div>
    `).join('');
    if (feedback && feedback.key_learnings) {
        html += `<div style="margin-top:20px; padding:15px; background:#f8fafc; border-left:4px solid #ef4444; font-size:0.85rem;">
                    <strong>Learnings:</strong><p>"${feedback.key_learnings}"</p>
                    <strong>Plan:</strong><p>${feedback.apply_plan}</p></div>`;
    }
    container.innerHTML = html;
}

function copySurveyLink(cohort, session) {
    const fullUrl = `${window.location.origin}/survey/${cohort}/${session}`;
    navigator.clipboard.writeText(fullUrl).then(() => {
        const status = document.getElementById('copyStatus');
        status.style.display = 'inline';
        setTimeout(() => { status.style.display = 'none'; }, 2000);
    });
}

// Analytics Charts
{% if cohort != 'All' %}
document.addEventListener('DOMContentLoaded', function() {
    // 1. Engagement Depth
    new ApexCharts(document.querySelector("#engagementDepthChart"), {
        series: [
            { name: 'Attended (Teams)', data: {{ attendance_totals|tojson if attendance_totals else [0,0,0,0,0,0] }} },
            { name: 'Surveyed (Forms)', data: {{ attendance_trend|tojson if attendance_trend else [0,0,0,0,0,0] }} }
        ],
        chart: { type: 'bar', height: 180, toolbar: {show: false} },
        colors: ['#2563eb', '#ef4444'],
        plotOptions: { bar: { borderRadius: 4, columnWidth: '55%' } },
        xaxis: { categories: ['S1', 'S2', 'S3', 'S4', 'S5', 'S6'] },
        legend: { position: 'top', fontSize: '10px' }
    }).render();

    // 2. Survey Volume
    new ApexCharts(document.querySelector("#attendanceTrendChart"), {
        series: [{ name: 'Participants', data: {{ attendance_trend|tojson if attendance_trend else [0,0,0,0,0,0] }} }],
        chart: { type: 'area', height: 180, toolbar: {show: false} },
        colors: ['#ef4444'],
        stroke: { curve: 'smooth', width: 2 },
        xaxis: { categories: ['S1', 'S2', 'S3', 'S4', 'S5', 'S6'] }
    }).render();

    // 3. Sentiment Radar
    new ApexCharts(document.querySelector("#sentimentRadarChart"), {
        series: [{ name: 'Avg Score', data: [{{ stats.q1 }}, {{ stats.q2 }}] }],
        chart: { type: 'radar', height: 180, toolbar: {show: false} },
        xaxis: { categories: ['Quality', 'Relevance'] },
        colors: ['#ef4444'],
        yaxis: { max: 5, show: false }
    }).render();

    // 4. Response Gauge
    const totalCount = {{ rows|length }};
    const sumAttend = {{ attendance_trend|sum }};
    const completedCount = Math.round(sumAttend / 6);
    new ApexCharts(document.querySelector("#responseGaugeChart"), {
        series: [completedCount, Math.max(0, totalCount - completedCount)],
        chart: { type: 'donut', height: 180 },
        labels: ['Active', 'Inactive'],
        colors: ['#ef4444', '#f1f5f9'],
        legend: { show: false },
        plotOptions: { pie: { donut: { labels: { show: true, total: { show: true, label: 'Engaged' } } } } }
    }).render();

    // 5. Verified Raw Attendance Trend (The missing chart logic fixed)
    new ApexCharts(document.querySelector("#verifiedAttendanceTrendChart"), {
        series: [{
            name: 'Raw External Headcount',
            data: {{ attendance_totals|tojson if attendance_totals else [0,0,0,0,0,0] }}
        }],
        chart: {
            type: 'area',
            height: 250,
            toolbar: { show: false },
            zoom: { enabled: false }
        },
        colors: ['#2563eb'],
        fill: {
            type: 'gradient',
            gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.1 }
        },
        stroke: { curve: 'smooth', width: 3 },
        dataLabels: { enabled: true },
        xaxis: {
            categories: ['Session 1', 'Session 2', 'Session 3', 'Session 4', 'Session 5', 'Session 6'],
            labels: { style: { colors: '#64748b', fontWeight: 600 } }
        },
        yaxis: { title: { text: 'Headcount' } },
        title: {
            text: 'Raw Meeting Headcount (Excluding Team)',
            align: 'left',
            style: { fontSize: '14px', color: '#1e293b', fontWeight: '700' }
        }
    }).render();
});
{% endif %}
</script>
</body>
</html>
